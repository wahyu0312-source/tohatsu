<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>スキャン | 品質管理生産技術</title>
<link rel="icon" href="tsh.png">
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="./assets/ui.css">
<style>
/* extra tweaks khusus halaman scan */
.grid{display:grid;gap:12px}
@media (min-width: 960px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
#video{width:100%;border:1px solid var(--line);border-radius:16px}
.canvas-box{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start}
.canvas-box canvas, .canvas-box svg{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.print-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
kbd{background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="hstack">
      <a href="./index.html" class="btn">←</a>
      <img src="tsh.png" alt="TSH" style="height:32px">
      <strong>スキャン</strong>
    </div>
    <div class="hstack">
      <span class="badge small" id="camState">Camera: —</span>
    </div>
  </div>
</header>

<main class="wrap" style="margin:28px auto">
  <div class="grid cols-2">
    <!-- ========== CAMERA SCAN ========== -->
    <section class="card">
      <div class="hstack" style="justify-content:space-between;flex-wrap:wrap">
        <h2>カメラでスキャン</h2>
        <div class="hstack" style="flex-wrap:wrap">
          <select id="deviceSel"></select>
          <button id="btnStart" class="btn primary">Start</button>
          <button id="btnStop" class="btn">Stop</button>
        </div>
      </div>

      <video id="video" playsinline></video>
      <div class="small" id="scanHint" style="margin-top:6px">カメラ準備中…</div>

      <div class="hstack" style="margin-top:12px;flex-wrap:wrap">
        <select id="ev" class="btn">
          <option value="RECEIVE">RECEIVE（受入）</option>
          <option value="WIP">WIP（工程中）</option>
          <option value="QC">QC（検査）</option>
          <option value="PACK">PACK（梱包）</option>
          <option value="SHIP">SHIP（出荷）</option>
        </select>
        <input id="loc" class="btn" placeholder="Location 例: 倉庫A / 組立1">
        <input id="note" class="btn" placeholder="Note (任意)">
        <label class="hstack small" style="gap:6px">
          <input type="checkbox" id="autoPost" checked> 自動登録
        </label>
        <button id="btnPostLast" class="btn">最後の読み取りを登録</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="hstack" style="justify-content:space-between">
          <strong>最後の読み取り</strong>
          <span id="lastTs" class="small">—</span>
        </div>
        <div class="hstack" style="gap:8px;margin-top:6px">
          <span class="badge">ID: <strong id="lastVal">—</strong></span>
          <span class="badge small" id="lastStatus">—</span>
        </div>
      </div>
    </section>

    <!-- ========== MANUAL & CODE GEN ========== -->
    <section class="card">
      <h2>手入力 & ラベル生成（カメラなしでもOK）</h2>
      <div class="hstack" style="flex-direction:column;align-items:stretch;gap:10px">
        <input id="mItem" placeholder="Item ID（図番/注番 等） * 必須">
        <div class="hstack" style="flex-wrap:wrap">
          <input id="mCustomer" placeholder="顧客 (任意)">
          <input id="mMachine" placeholder="機種 (任意)">
        </div>
        <input id="mNote" placeholder="Note (任意)">
        <div class="hstack" style="flex-wrap:wrap">
          <button id="mGen" class="btn primary">QR/Barcode を生成</button>
          <button id="mPost" class="btn">受入として登録 (RECEIVE)</button>
        </div>
      </div>

      <div class="canvas-box" style="margin-top:12px">
        <div>
          <div class="small">QR Code</div>
          <canvas id="qrCanvas" width="256" height="256"></canvas>
          <div class="print-controls">
            <button id="dlQR" class="btn">Download PNG</button>
          </div>
        </div>
        <div>
          <div class="small">Barcode (CODE128)</div>
          <svg id="barcode"></svg>
          <div class="print-controls">
            <button id="dlBar" class="btn">Download PNG</button>
          </div>
        </div>
      </div>

      <div class="hstack print-controls" style="margin-top:10px">
        <label class="small">枚数</label>
        <input id="copies" type="number" min="1" value="6" style="width:90px">
        <button id="btnPrint" class="btn">ラベルを印刷</button>
        <span class="small">ヒント: <kbd>Ctrl/Cmd + P</kbd> でダイアログ</span>
      </div>

      <div class="small" id="mHint" style="margin-top:8px"></div>
    </section>
  </div>
</main>

<div class="footer">Design by Wahyu</div>

<!-- ===== Libraries ===== -->
<script src="./assets/config.js"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<script>
// ===== PWA: register service worker =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  });
}

const S = s => String(s ?? '').trim();
const { LOG_API, LOG_TOKEN, CURRENT_USER } = APP;

// ===== Camera Scan =====
let reader = null, controls = null, lastText = null;
const video = document.getElementById('video');
const deviceSel = document.getElementById('deviceSel');
const camState = document.getElementById('camState');
const scanHint = document.getElementById('scanHint');
const lastVal = document.getElementById('lastVal');
const lastStatus = document.getElementById('lastStatus');
const lastTs = document.getElementById('lastTs');

async function listDevices(){
  try{
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    deviceSel.innerHTML = devices.map(d=>`<option value="${d.deviceId}">${d.label||'Camera'}</option>`).join('');
    camState.textContent = `Camera: ${devices.length? (devices[0].label||'1 device') : 'None'}`;
    if(!devices.length){
      // no camera: focus manual section
      document.querySelector('#mItem').focus();
      scanHint.textContent = 'カメラが見つかりません。手入力＋ラベル生成をご利用ください。';
    } else {
      scanHint.textContent = 'カメラ準備OK。Startで読み取り開始。';
    }
  }catch(e){
    camState.textContent = 'Camera: error';
    scanHint.textContent = 'カメラの初期化に失敗しました。HTTPSでアクセスしてください。';
  }
}

async function startScan(){
  try{
    if(!reader) reader = new ZXingBrowser.BrowserMultiFormatReader();
    const id = deviceSel.value || undefined;
    scanHint.textContent = '読み取り中…';
    controls = await reader.decodeFromVideoDevice(id, video, async (result, err, ctrl) => {
      if(result){
        const txt = result.getText();
        if(txt && txt !== lastText){
          lastText = txt;
          lastVal.textContent = txt;
          lastTs.textContent = new Date().toLocaleString();
          lastStatus.textContent = '未送信';
          if(document.getElementById('autoPost').checked){
            await postScan(txt);
          }else{
            scanHint.textContent = '読み取り完了。登録ボタンで送信します。';
          }
        }
      }
    });
    camState.textContent = 'Camera: scanning';
  }catch(e){
    scanHint.textContent = 'スキャン開始に失敗：' + e.message;
  }
}
function stopScan(){
  try{ controls?.stop(); reader?.reset(); }catch(e){}
  camState.textContent = 'Camera: stopped';
  scanHint.textContent = '停止しました。';
}

async function postScan(itemId){
  const ev = S(document.getElementById('ev').value);
  const loc = S(document.getElementById('loc').value);
  const note = S(document.getElementById('note').value);
  lastStatus.textContent = '送信中…';
  try{
    const payload = { token: LOG_TOKEN, action: 'scan', item_id: itemId, event: ev, location: loc, user: CURRENT_USER, note };
    const res = await fetch(LOG_API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if(j.ok){ lastStatus.textContent = '登録しました ✅'; scanHint.textContent = 'サーバー登録OK'; }
    else { lastStatus.textContent = '送信失敗'; scanHint.textContent = '送信失敗: ' + (j.error || res.status); }
  }catch(e){ lastStatus.textContent='送信エラー'; scanHint.textContent='送信エラー: '+e.message; }
}

// Buttons
document.getElementById('btnStart').addEventListener('click', startScan);
document.getElementById('btnStop').addEventListener('click', stopScan);
document.getElementById('btnPostLast').addEventListener('click', ()=>{ if(lastText) postScan(lastText); });

// ===== Manual + Code Generation =====
const qrCanvas = document.getElementById('qrCanvas');
const barcodeSvg = document.getElementById('barcode');
const mHint = document.getElementById('mHint');

async function genCodes(){
  const id = S(document.getElementById('mItem').value);
  if(!id){ mHint.textContent = 'Item ID を入力してください。'; return; }
  mHint.textContent = '生成中…';

  // QR (content: pure item_id for compatibility with scanner)
  await QRCode.toCanvas(qrCanvas, id, { width:256, margin:1, errorCorrectionLevel:'M' });

  // Barcode CODE128
  JsBarcode(barcodeSvg, id, { format: 'CODE128', displayValue: true, fontSize: 16, height: 80, margin: 4 });

  mHint.textContent = 'QR / Barcode を生成しました。';
}

async function manualPost(){
  const id = S(document.getElementById('mItem').value);
  if(!id){ mHint.textContent = 'Item ID は必須です。'; return; }
  mHint.textContent = '送信中…';
  try{
    const payload = { token: LOG_TOKEN, action: 'scan', item_id: id, event: 'RECEIVE',
      location: S(document.getElementById('mCustomer').value || document.getElementById('mMachine').value),
      user: CURRENT_USER, note: S(document.getElementById('mNote').value)
    };
    const res = await fetch(LOG_API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    mHint.textContent = j.ok ? '登録しました ✅ そのままラベルを印刷できます。' : ('送信失敗: ' + (j.error || res.status));
  }catch(e){ mHint.textContent='送信エラー: '+e.message; }
}

function downloadCanvasPNG(canvas, filename){
  const a = document.createElement('a');
  a.download = filename;
  a.href = canvas.toDataURL('image/png');
  a.click();
}

function svgToPngDataUrl(svgElem, width=400, height=140){
  const svgData = new XMLSerializer().serializeToString(svgElem);
  const img = new Image();
  const canvas = document.createElement('canvas');
  canvas.width = width; canvas.height = height;
  const ctx = canvas.getContext('2d');
  return new Promise(resolve=>{
    img.onload = ()=>{
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,width,height);
      ctx.drawImage(img,0,0,width,height);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
  });
}

async function downloadBarcodePNG(){
  const url = await svgToPngDataUrl(barcodeSvg);
  const a = document.createElement('a');
  a.download = 'barcode.png';
  a.href = url;
  a.click();
}

async function printLabels(){
  const id = S(document.getElementById('mItem').value);
  if(!id){ mHint.textContent='先に Item ID を入力して生成してください。'; return; }
  await genCodes(); // ensure fresh
  const qrUrl = qrCanvas.toDataURL('image/png');
  const barUrl = await svgToPngDataUrl(barcodeSvg);
  const copies = Math.max(1, parseInt(document.getElementById('copies').value||'1',10));

  const w = window.open('', '_blank');
  const html = `
<!doctype html><html><head>
<meta charset="utf-8">
<title>Print ${id}</title>
<style>
@page{ margin:10mm }
body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif }
.sheet{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px }
.card{ border:1px solid #ddd; padding:8px; border-radius:8px }
h4{ margin:0 0 4px 0; font-size:12px }
.row{ display:flex; gap:8px; align-items:center }
.row img{ display:block; }
.small{ font-size:10px; color:#374151 }
</style>
</head>
<body>
<div class="sheet">
  ${Array.from({length:copies}).map(()=>`
  <div class="card">
    <h4>ID: ${id}</h4>
    <div class="row">
      <img src="${qrUrl}" width="96" height="96" alt="QR">
      <div>
        <img src="${barUrl}" width="220" height="80" alt="BAR">
        <div class="small">顧客: ${S(document.getElementById('mCustomer').value)||'-'} / 機種: ${S(document.getElementById('mMachine').value)||'-'}</div>
      </div>
    </div>
  </div>`).join('')}
</div>
<script>window.onload=()=>window.print()</script>
</body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}

// Events (manual)
document.getElementById('mGen').addEventListener('click', genCodes);
document.getElementById('mPost').addEventListener('click', manualPost);
document.getElementById('dlQR').addEventListener('click', ()=> downloadCanvasPNG(qrCanvas,'qrcode.png'));
document.getElementById('dlBar').addEventListener('click', downloadBarcodePNG);
document.getElementById('btnPrint').addEventListener('click', printLabels);

// Boot
window.addEventListener('DOMContentLoaded', async ()=>{
  await listDevices();
});
</script>
</body>
</html>
