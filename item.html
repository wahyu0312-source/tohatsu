<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>タイムライン | 品質管理生産技術</title>
<link rel="icon" href="tsh.png">
<link rel="stylesheet" href="./assets/ui.css">
</head>
<body>
<header>
  <div class="wrap">
    <div class="hstack">
      <a href="./index.html" class="btn">←</a>
      <img src="tsh.png" alt="TSH" style="height:32px">
      <strong>タイムライン</strong>
    </div>
    <div class="hstack">
      <input id="itemId" placeholder="図番/注番を入力">
      <button id="go" class="btn primary">表示</button>
    </div>
  </div>
</header>

<main class="wrap" style="margin:28px auto">
  <section class="card">
    <div class="hstack" style="justify-content:space-between;flex-wrap:wrap">
      <h2 id="title">アイテム：—</h2>
      <span id="summary" class="badge small">—</span>
    </div>
    <table class="table">
      <thead>
        <tr><th>日時</th><th>イベント</th><th>場所</th><th>ユーザー</th><th>メモ</th></tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
  </section>
</main>

<div class="footer">Design by Wahyu</div>

<script src="./assets/config.js"></script>
<script>
const LOG_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vSmw6oMhjQRmXjSL9R9PhBZGa0aJ5WrxHKYzcOpACGOo1GEV0NimYgpTAsnUiNg7nT4tEQ-euqDSSVt/pub?gid=2085218630&single=true&output=csv";
const S=s=>String(s??'').trim();
const qs=new URLSearchParams(location.search);
function parseCSV(t){const r=[],re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;let m,row=[];t=t.replace(/\r\n?/g,"\n");
for(let i=0;i<t.length;){re.lastIndex=i;m=re.exec(t);if(!m)break;let c=m[1];if(c.startsWith('"'))c=c.slice(1,-1).replace(/""/g,'"');row.push(c);i=re.lastIndex;if(m[2]==="\n"||m[2]===""){r.push(row);row=[]}}return r.filter(a=>a.length&&a.some(c=>S(c)!==""));}

async function load(id){
  if(!id){ document.getElementById('title').textContent='アイテム：—'; document.getElementById('body').innerHTML=''; return; }
  document.getElementById('title').textContent='アイテム：'+id;
  const res=await fetch(LOG_CSV+"&_ts="+Date.now(),{cache:'no-store'}); if(!res.ok) return;
  const rows=parseCSV(await res.text()); const h=rows[0].map(S);
  const iId=h.indexOf('item_id'), iTS=h.indexOf('ts'), iEv=h.indexOf('event'), iLoc=h.indexOf('location'), iUser=h.indexOf('user'), iNote=h.indexOf('note');
  const list=rows.slice(1).filter(r=>S(r[iId])===id).map(r=>({
    ts:new Date(S(r[iTS])||0).getTime(), ev:S(r[iEv]), loc:S(r[iLoc]), user:S(r[iUser]), note:S(r[iNote])
  })).sort((a,b)=>b.ts-a.ts);
  const tb=document.getElementById('body'); tb.innerHTML='';
  list.forEach(x=>{
    const dt = isFinite(x.ts)? new Date(x.ts).toLocaleString() : '-';
    tb.insertAdjacentHTML('beforeend', `<tr>
      <td>${dt}</td><td><span class="pill">${x.ev||'-'}</span></td>
      <td>${x.loc||'-'}</td><td>${x.user||'-'}</td><td>${x.note||''}</td>
    </tr>`);
  });
  const last = list[0];
  document.getElementById('summary').textContent = last ? `最新: ${last.ev} @ ${last.loc}` : '記録なし';
}
const initId = S(qs.get('id')||'');
document.getElementById('itemId').value = initId;
document.getElementById('go').addEventListener('click', ()=> load(S(document.getElementById('itemId').value)));
window.addEventListener('DOMContentLoaded', ()=> load(initId));
</script>
</body>
</html>
