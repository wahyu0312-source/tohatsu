<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>在庫 | 品質管理生産技術</title>
<link rel="icon" href="tsh.png">
<link rel="stylesheet" href="./assets/ui.css">
</head>
<body>
<header>
  <div class="wrap">
    <div class="hstack">
      <a href="./index.html" class="btn">←</a>
      <img src="tsh.png" alt="TSH" style="height:32px">
      <strong>在庫</strong>
    </div>
    <div class="hstack">
      <input id="q" placeholder="検索（図番 / 顧客 / 機種）">
      <button id="btnRefresh" class="btn">Refresh</button>
    </div>
  </div>
</header>

<main class="wrap" style="margin:28px auto">
  <section class="card">
    <div class="hstack" style="justify-content:space-between;flex-wrap:wrap">
      <h2>在庫一覧（最新基準）</h2>
      <span id="count" class="badge small">0</span>
    </div>
    <table class="table">
      <thead>
        <tr><th>図番</th><th>商品名</th><th>顧客</th><th>機種</th><th>数量</th><th>最新イベント</th><th>現在位置</th></tr>
      </thead>
      <tbody id="body"></tbody>
    </table>
    <div class="small" id="hint"></div>
  </section>
</main>

<div class="footer">Design by Wahyu</div>

<script src="./assets/config.js"></script>
<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSmw6oMhjQRmXjSL9R9PhBZGa0aJ5WrxHKYzcOpACGOo1GEV0NimYgpTAsnUiNg7nT4tEQ-euqDSSVt/pub?gid=0&single=true&output=csv";
const LOG_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vSmw6oMhjQRmXjSL9R9PhBZGa0aJ5WrxHKYzcOpACGOo1GEV0NimYgpTAsnUiNg7nT4tEQ-euqDSSVt/pub?gid=2085218630&single=true&output=csv";
const S=s=>String(s??'').trim();
function parseCSV(t){const r=[],re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;let m,row=[];t=t.replace(/\r\n?/g,"\n");
for(let i=0;i<t.length;){re.lastIndex=i;m=re.exec(t);if(!m)break;let c=m[1];if(c.startsWith('"'))c=c.slice(1,-1).replace(/""/g,'"');row.push(c);i=re.lastIndex;if(m[2]==="\n"||m[2]===""){r.push(row);row=[]}}return r.filter(a=>a.length&&a.some(c=>S(c)!==""));}

async function load(){
  const [resMaster, resLog] = await Promise.all([
    fetch(CSV_URL+"&_ts="+Date.now(),{cache:'no-store'}),
    fetch(LOG_CSV+"&_ts="+Date.now(),{cache:'no-store'})
  ]);
  if(!resMaster.ok) return;
  const master=parseCSV(await resMaster.text());
  const head=master[0].map(S);
  const iDraw=head.indexOf('図番'); const iItem=head.indexOf('商品名');
  const iCust=head.indexOf('顧客名'); const iMach=head.indexOf('機種'); const iQty=head.indexOf('数量');

  let latestMap={};
  if(resLog.ok){
    const rows=parseCSV(await resLog.text()); const h=rows[0].map(S);
    const iId=h.indexOf('item_id'), iTS=h.indexOf('ts'), iEv=h.indexOf('event'), iLoc=h.indexOf('location');
    for(let k=1;k<rows.length;k++){
      const id=S(rows[k][iId]); const ts=new Date(S(rows[k][iTS])||0).getTime(); if(!id||!ts) continue;
      if(!latestMap[id]||ts>latestMap[id].ts){ latestMap[id]={ev:S(rows[k][iEv]), loc:S(rows[k][iLoc]), ts}; }
    }
  }

  const q=S(document.getElementById('q').value).toLowerCase();
  const body=document.getElementById('body'); body.innerHTML='';
  let n=0;
  for(let r=1;r<master.length;r++){
    const d=S(master[r][iDraw]), it=S(master[r][iItem]), cu=S(master[r][iCust]), ma=S(master[r][iMach]), qt=S(master[r][iQty]);
    const key=d||it; const l=latestMap[key]||{};
    const hay=(d+' '+it+' '+cu+' '+ma).toLowerCase();
    if(q && !hay.includes(q)) continue;
    n++;
    body.insertAdjacentHTML('beforeend', `<tr>
      <td><a href="./item.html?id=${encodeURIComponent(d||it)}">${d||'-'}</a></td>
      <td>${it||'-'}</td><td>${cu||'-'}</td><td>${ma||'-'}</td><td>${qt||'-'}</td>
      <td>${l.ev||'-'}</td><td>${l.loc||'-'}</td>
    </tr>`);
  }
  document.getElementById('count').textContent = n+' 件';
  document.getElementById('hint').textContent = '在庫はCSV最新情報＋スキャン最新を付加して表示しています。';
}
document.getElementById('btnRefresh')?.addEventListener('click', load);
document.getElementById('q').addEventListener('input', load);
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
