<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“ã‚·ã‚¹ãƒ†ãƒ </title>
<link rel="icon" href="tsh.png">
<style>
/* ====== Elegant + Mobile (inline CSS) ====== */
:root{
  --bg1:#f6f8fc; --bg2:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
  --accent:#2563eb; --accent-ink:#fff; --danger:#dc2626;
  --radius:22px; --shadow:0 20px 40px rgba(15,23,42,.08); --shadow-sm:0 6px 16px rgba(15,23,42,.06);
  --blur:12px; --focus:0 0 0 3px rgba(37,99,235,.25);
}
@media (prefers-color-scheme: dark){
  :root{ --bg1:#0b1220; --bg2:#101828; --ink:#e5e7eb; --muted:#94a3b8; --line:#243244;
    --shadow:0 18px 36px rgba(0,0,0,.5); --shadow-sm:0 8px 20px rgba(0,0,0,.35); }
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",sans-serif;
  background:
    radial-gradient(1400px 700px at -10% -10%, rgba(37,99,235,.06), transparent 60%),
    radial-gradient(900px 500px at 110% -10%, rgba(37,99,235,.05), transparent 60%),
    var(--bg1);
  letter-spacing:.2px;
}
.wrap{max-width:1200px;margin:0 auto;padding:0 18px}
.hstack{display:flex;align-items:center;gap:12px}
.small{font-size:.875rem;color:var(--muted)}
/* Header */
header{position:sticky;top:0;z-index:50;background:color-mix(in oklab,var(--bg1) 75%,transparent);
  backdrop-filter:blur(var(--blur));border-bottom:1px solid color-mix(in oklab,var(--line) 80%,transparent)}
header .wrap{height:64px;display:flex;align-items:center;justify-content:space-between}
.nav{display:flex;gap:18px}
.nav a{color:var(--muted);text-decoration:none;font-weight:600;padding:8px 10px;border-radius:12px;transition:.18s}
.nav a:hover{color:var(--ink);background:color-mix(in oklab,var(--line) 20%,transparent)}
.nav a strong{color:var(--ink)}
/* Buttons / inputs */
.btn{appearance:none;border:1px solid var(--line);background:var(--bg2);color:var(--ink);
  padding:10px 14px;border-radius:14px;font-weight:600;box-shadow:var(--shadow-sm);cursor:pointer;
  transition:transform .04s, box-shadow .18s, background .18s}
.btn:hover{box-shadow:var(--shadow)} .btn:active{transform:translateY(1px)} .btn:focus-visible{box-shadow:var(--shadow),var(--focus)}
.btn.primary{background:var(--accent);color:#fff;border-color:transparent}
.badge{display:inline-flex;align-items:center;gap:6px;background:color-mix(in oklab,var(--accent) 12%,var(--bg2));
  color:color-mix(in oklab,var(--accent) 85%,black);border:1px solid color-mix(in oklab,var(--accent) 30%,var(--line));
  padding:6px 10px;border-radius:999px;font-weight:700}
.badge.small{font-size:.82rem;padding:4px 8px}
input[type="text"],input[type="date"],input[type="search"],select{
  background:var(--bg2);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:inherit;outline:0;
}
input:focus,select:focus{box-shadow:var(--focus);border-color:color-mix(in oklab,var(--accent) 60%,var(--line))}
/* Cards */
.card{background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 20px}
.card h2{margin:4px 0 0;font-size:1.25rem}
#urgent-banner{padding:16px 20px;border-radius:var(--radius);background:var(--danger);color:#fff;box-shadow:var(--shadow)}
/* Table */
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;overflow:hidden;border-radius:16px;border:1px solid var(--line)}
.table thead th{position:sticky;top:0;background:color-mix(in oklab,var(--bg2) 80%,var(--bg1));
  text-align:left;font-weight:800;font-size:.95rem;color:var(--muted);padding:12px 14px;border-bottom:1px solid var(--line)}
.table tbody td{padding:12px 14px;border-bottom:1px solid color-mix(in oklab,var(--line) 70%,transparent);vertical-align:top;
  max-width:280px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
.table tbody tr:nth-child(odd){background:color-mix(in oklab,var(--bg1) 35%,transparent)}
.table tbody tr:hover{background:color-mix(in oklab,var(--accent) 6%,transparent)}
.table a{color:var(--accent);text-decoration:none;font-weight:700}
.table a:hover{text-decoration:underline}
.pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;font-weight:700;background:var(--bg1);border:1px solid var(--line)}
.tag-done{background:#16a34a;color:#fff}.tag-inspect{background:#7c3aed;color:#fff}.tag-assem{background:#0ea5e9;color:#fff}
.tag-assem-done{background:#22c55e;color:#fff}.tag-not{background:#e2e8f0;color:#0f172a}
#procPills{display:flex;flex-wrap:wrap;gap:8px} #procHint{margin-top:6px}
/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.45);z-index:100;padding:18px}
.modal .box{background:var(--bg2);border:1px solid var(--line);border-radius:18px;width:min(720px,96vw);padding:18px;box-shadow:var(--shadow);
  animation:modalIn .18s ease-out}
@keyframes modalIn{from{transform:translateY(6px);opacity:0}to{transform:translateY(0);opacity:1}}
/* ===== Drawer Sidebar (mobile) ===== */
.drawer{position:fixed;inset:0;z-index:70;display:none}
.drawer.open{display:block}
.drawer .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45)}
.drawer .panel{position:absolute;top:0;left:0;height:100%;width:min(84vw,320px);background:var(--bg2);
  border-right:1px solid var(--line);box-shadow:var(--shadow);padding:18px;overflow:auto}
.drawer .menu a{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;
  color:var(--ink);text-decoration:none;border:1px solid transparent}
.drawer .menu a:hover{background:color-mix(in oklab,var(--line) 22%,transparent);border-color:var(--line)}
/* ===== Bottom Nav (mobile) ===== */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--bg2);border-top:1px solid var(--line);
  display:none;z-index:60}
.bottom-nav .bar{display:flex;justify-content:space-around;padding:6px 4px}
.bottom-nav a{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 6px;text-decoration:none;color:var(--muted);font-size:.78rem}
.bottom-nav a.active{color:var(--accent);font-weight:700}
.bottom-nav svg{width:22px;height:22px}
/* Responsive */
.menu-btn{display:none}
@media (max-width: 960px){
  .nav{display:none}
  .menu-btn{display:inline-flex}
  .wrap{padding:0 14px}
  .card{padding:16px}
  .bottom-nav{display:block}
  main{padding-bottom:72px} /* space for bottom nav */
}
.footer{text-align:center;color:var(--muted);padding:30px 0 80px;font-size:.9rem}
</style>
</head>
<body>
  <!-- Drawer Sidebar -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" id="drawerClose"></div>
    <aside class="panel">
      <div class="hstack" style="justify-content:space-between">
        <div class="hstack"><img src="tsh.png" alt="TSH" style="height:28px"><strong>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong></div>
        <button class="btn" id="drawerCloseBtn">âœ•</button>
      </div>
      <div class="menu" style="margin-top:12px">
        <a href="./index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
        <a href="./position.html">ğŸ“ ãƒã‚¸ã‚·ãƒ§ãƒ³</a>
        <a href="./item.html">ğŸ•’ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</a>
        <a href="./inventory.html">ğŸ“¦ åœ¨åº«</a>
        <a href="./receive.html">ğŸ“¥ å—å…¥</a>
        <a href="./issue.html">ğŸ“¤ æ‰•å‡º</a>
      </div>
      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">
      <div class="hstack" style="gap:8px;flex-wrap:wrap">
        <button id="btnRefresh2" class="btn">Refresh</button>
        <button id="btnLive2" class="btn">Live</button>
        <button id="btnScan2" class="btn">Scan</button>
        <button id="btnManual2" class="btn">Input</button>
      </div>
    </aside>
  </div>

  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="hstack">
        <button id="menuBtn" class="btn menu-btn" aria-label="Menu">â˜°</button>
        <img src="tsh.png" alt="TSH" style="height:36px">
        <strong>å“è³ªç®¡ç†ç”Ÿç”£æŠ€è¡“</strong>
      </div>
      <nav class="nav">
        <a href="./index.html"><strong>ãƒ›ãƒ¼ãƒ </strong></a>
        <a href="./position.html">ãƒã‚¸ã‚·ãƒ§ãƒ³</a>
        <a href="./item.html">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</a>
        <a href="./inventory.html">åœ¨åº«</a>
        <a href="./receive.html">å—å…¥</a>
        <a href="./issue.html">æ‰•å‡º</a>
      </nav>
      <div class="hstack">
        <button id="btnRefresh" class="btn">Refresh</button>
        <button id="btnLive" class="btn">Live</button>
        <span id="intervalInfo" class="badge">60s</span>
        <button id="btnScan" class="btn">Scan</button>
        <button id="btnManual" class="btn">Input</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="wrap" style="margin:28px auto">
    <div id="urgent-banner" class="card">ç¾åœ¨ã€è‡³æ€¥æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>

    <section class="card" id="processBoard" style="margin-top:16px">
      <div class="hstack" style="justify-content:space-between">
        <h2>å·¥ç¨‹é€²æ—ï¼ˆæœ€æ–°ã‚¹ã‚­ãƒ£ãƒ³åŸºæº–ï¼‰</h2>
        <span class="badge small">æœ€æ–°ä»¶æ•°</span>
      </div>
      <div class="hstack" id="procPills" style="margin-top:8px;flex-wrap:wrap"></div>
      <div class="small" id="procHint"></div>
    </section>

    <section id="todaySection" class="card" style="display:none;margin-top:16px">
      <div class="hstack" style="justify-content:space-between">
        <h2>æœ¬æ—¥å‡ºè·</h2>
        <span class="badge"><span>ä»¶æ•°</span><strong id="todayCount" style="margin-left:6px">0</strong></span>
      </div>
      <table id="todayTable" class="table">
        <thead><tr id="todayHead"></tr></thead>
        <tbody id="todayBody"></tbody>
      </table>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="hstack" style="justify-content:space-between; flex-wrap:wrap">
        <h2>å…¨ä»¶ä¸€è¦§</h2>
        <div class="hstack" style="flex-wrap:wrap">
          <label class="small">å‡ºè·æ—¥ï¼š</label>
          <input type="date" id="filterDate">
          <button class="btn" id="btnToday">æœ¬æ—¥å‡ºè·ã®ã¿</button>
          <button class="btn" id="btnClear">Clear</button>
          <button class="btn" id="btnExcel">Export Excel</button>
        </div>
      </div>
      <table id="shipTable" class="table">
        <thead><tr id="shipHead"></tr></thead>
        <tbody id="shipBody"></tbody>
      </table>
      <div class="small" id="shipHint"></div>
    </section>
  </main>

  <!-- Bottom Navigation (mobile) -->
  <nav class="bottom-nav" aria-label="Bottom navigation">
    <div class="bar">
      <a href="./index.html" class="active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
        ãƒ›ãƒ¼ãƒ 
      </a>
      <a href="./item.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4h18"/><path d="M3 12h18"/><path d="M3 20h18"/></svg>
        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
      </a>
      <a href="javascript:void(0)" id="bnScan">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        ã‚¹ã‚­ãƒ£ãƒ³
      </a>
      <a href="./inventory.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-2-2h-5V4H10v2H5a2 2 0 0 0-2 2v8"/></svg>
        åœ¨åº«
      </a>
      <a href="javascript:void(0)" id="bnMore">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
        ãã®ä»–
      </a>
    </div>
  </nav>

  <div class="footer">Design by Wahyu</div>

  <!-- ===== Libraries ===== -->
  <script src="./assets/config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <!-- ===== App Script ===== -->
  <script>
  // ===== Config shortcuts =====
  const SHEET_ID = APP.SHEET_ID, TAB_NAME = APP.TAB_MASTER;

  // CSV master (æœ€æ–°æƒ…å ±)
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmw6oMhjQRmXjSL9R9PhBZGa0aJ5WrxHKYzcOpACGOo1GEV0NimYgpTAsnUiNg7nT4tEQ-euqDSSVt/pub?gid=0&single=true&output=csv";

  // CSV scan_log (PERBAIKAN: pakai gid=2085218630)
  const LOG_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmw6oMhjQRmXjSL9R9PhBZGa0aJ5WrxHKYzcOpACGOo1GEV0NimYgpTAsnUiNg7nT4tEQ-euqDSSVt/pub?gid=2085218630&single=true&output=csv";

  const LOG_API  = APP.LOG_API, LOG_TOKEN = APP.LOG_TOKEN, CURRENT_USER = APP.CURRENT_USER;
  const S = s => String(s ?? '').trim();

  // ===== CSV parser =====
  function parseCSV(t){
    const rows=[], re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g; let m, row=[];
    t=t.replace(/\r\n?/g,"\n");
    for(let i=0;i<t.length;){ re.lastIndex=i; m=re.exec(t); if(!m) break;
      let cell=m[1]; if(cell.startsWith('"')) cell=cell.slice(1,-1).replace(/""/g,'"');
      row.push(cell); i=re.lastIndex; if(m[2]==="\n"||m[2]===""){ rows.push(row); row=[]; } }
    return rows.filter(r=>r.length && r.some(c=>S(c)!==""));
  }

  // ===== Header indexer =====
  function indexByName(header){
    const map={}; header.forEach((h,i)=>map[S(h)]=i);
    const find=names=>{for(const n of names){if(n in map) return map[n];} return null;};
    const findFuzzy=rx=>{for(let i=0;i<header.length;i++){ if(rx.test(S(header[i]))) return i; } return null;};
    return {
      date:find(["å‡ºè·æ—¥","æ—¥ä»˜","Date"]),
      cust:find(["é¡§å®¢å","å®¢å…ˆ","Customer"]),
      draw:find(["å›³ç•ª","Drawing","å›³é¢"]),
      item:find(["å•†å“å","å“å","Item"]),
      machine:find(["æ©Ÿç¨®","æ©Ÿç¨®å","Machine"]),
      qty:find(["æ•°é‡","Qty"]),
      to:find(["é€ã‚Šå…ˆ","ç´å“å…ˆ","é€ä»˜å…ˆ"]),
      note:find(["æ³¨ç•ª","æ³¨æ–‡ç•ªå·","å‚™è€ƒ","æ³¨æ–‡","Order","æ³¨é‡ˆ"]),
      status_done:find(["è£½å“çŠ¶æ³","è£½å“çŠ¶æ…‹","ç´å“çŠ¶æ³"]) ?? findFuzzy(/(è£½å“|ç´å“).*(çŠ¶æ³|çŠ¶æ…‹)/),
      status_flag:find(["Status","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","çŠ¶æ…‹","è‡³æ€¥"]) ?? findFuzzy(/status|è‡³æ€¥/i),
    };
  }
  const valAt = (row, idx) => (idx==null ? "" : (row[idx] ?? ""));

  // ===== Date helpers =====
  function parseJPDate(str){
    const s=S(str); const mJP=s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})/);
    if(mJP) return new Date(mJP[1], mJP[2]-1, mJP[3]);
    const parts=s.replaceAll('-','/').split('/'); if(parts.length===3) return new Date(parts[0], parts[1]-1, parts[2]);
    const d=new Date(s); return isNaN(d)?null:d;
  }
  function sameYMD(a,b){ return a&&b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function toInputDate(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function isUrgent(v){ const t=S(v).toLowerCase(); return t==="è‡³æ€¥"||t==="urgent"||t==="ç·Šæ€¥"||t==="1"||t==="true"; }

  // ===== Status badge =====
  function getStatusFromValue(val){
    const raw=S(val), t=raw.replace(/\s/g,'').toLowerCase();
    if(!t || /(æœª|clear)/.test(t)) return {label:'æœªçµ„ç«‹', cls:'tag-not'};
    if(/(æ¤œæŸ»æ¸ˆã¿|æ¸ˆ|å®Œäº†|ok|done)/.test(t)) return {label:'æ¸ˆ', cls:'tag-done'};
    if(/(çµ„ç«‹å®Œäº†)/.test(raw)) return {label:'çµ„ç«‹å®Œäº†', cls:'tag-assem-done'};
    if(/(æ¤œæŸ»ä¸­|æ¤œä¸­)/.test(raw)) return {label:'æ¤œæŸ»ä¸­', cls:'tag-inspect'};
    if(/(çµ„ç«‹ä¸­|çµ„ä¸­)/.test(raw)) return {label:'çµ„ç«‹ä¸­', cls:'tag-assem'};
    if(/æ¤œ/.test(raw)) return {label:'æ¤œæŸ»ä¸­', cls:'tag-inspect'};
    if(/çµ„/.test(raw)) return {label:'çµ„ç«‹ä¸­', cls:'tag-assem'};
    return null;
  }
  function makeComparator(idx){
    const rank=s=>({'æ¤œæŸ»ä¸­':1,'çµ„ç«‹ä¸­':2,'æœªçµ„ç«‹':3,'çµ„ç«‹å®Œäº†':4,'æ¸ˆ':5}[s]??99);
    return (a,b)=>{
      const au=idx.status_flag!=null && isUrgent(valAt(a, idx.status_flag));
      const bu=idx.status_flag!=null && isUrgent(valAt(b, idx.status_flag));
      if(au!==bu) return au?-1:1;
      const sa=idx.status_done!=null?(getStatusFromValue(valAt(a, idx.status_done))?.label):null;
      const sb=idx.status_done!=null?(getStatusFromValue(valAt(b, idx.status_done))?.label):null;
      if(rank(sa)!==rank(sb)) return rank(sa)-rank(sb);
      const da=idx.date!=null?parseJPDate(valAt(a, idx.date)):null;
      const db=idx.date!=null?parseJPDate(valAt(b, idx.date)):null;
      return (db?db.getTime():-Infinity)-(da?da.getTime():-Infinity);
    };
  }

  // ===== Scan log latest map =====
  async function fetchScanMap(){
    try{
      const res = await fetch(LOG_CSV + "&_ts=" + Date.now(), {cache:'no-store'});
      if(!res.ok){ return {map:{}, stats:{}}; }
      const text=await res.text(); const rows=parseCSV(text);
      if(rows.length<2) return {map:{}, stats:{}};
      const header=rows[0].map(S);
      const idx={ ts:header.indexOf('ts'), id:header.indexOf('item_id'), ev:header.indexOf('event'), loc:header.indexOf('location') };
      const map={}, statsEvent={}, statsLoc={};
      for(let i=1;i<rows.length;i++){
        const r=rows[i], id=S(r[idx.id]); const ts=new Date(S(r[idx.ts])||0).getTime(); if(!id||!ts) continue;
        const ev=S(r[idx.ev]), loc=S(r[idx.loc]);
        if(!map[id] || ts > map[id].ts){ map[id]={ts, event:ev, location:loc}; }
        statsEvent[ev]=(statsEvent[ev]||0)+1;
      }
      Object.values(map).forEach(({event, location})=>{
        statsLoc[location||'-']=(statsLoc[location||'-']||0)+1;
        statsEvent[event||'-']=statsEvent[event||'-']||0;
      });
      return {map, stats:{event:statsEvent, location:statsLoc, total:Object.keys(map).length}};
    }catch(e){ console.warn('fetchScanMap', e); return {map:{}, stats:{}}; }
  }

  // ===== Rendering =====
  function renderTable(header, idx, rows, tbodyEl, headEl, latestMap){
    const extHeader=[...header,'æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆ','ç¾åœ¨ä½ç½®'];
    headEl.innerHTML = extHeader.map(h=>`<th>${h}</th>`).join('');
    tbodyEl.innerHTML = '';

    rows.forEach(r=>{
      const rowUrg=idx.status_flag!=null?isUrgent(valAt(r, idx.status_flag)):false;
      const tds=header.map((_,i)=>`<td>${S(r[i])}</td>`);

      // Link å›³ç•ª â†’ timeline
      if(idx.draw!=null){
        const rawId=S(valAt(r, idx.draw));
        if(rawId) tds[idx.draw]=`<td><a href="./item.html?id=${encodeURIComponent(rawId)}">${rawId}</a></td>`;
      }

      const dateCol=idx.date!=null?idx.date:0;
      const d=idx.date!=null?parseJPDate(valAt(r, idx.date)):null;
      const dateText=d?toInputDate(d):S(r[dateCol]||'');
      const statusObj=idx.status_done!=null?getStatusFromValue(valAt(r, idx.status_done)):null;
      const urgentFlag=rowUrg?`<span class="pill" style="background:#dc2626;color:#fff">è‡³æ€¥</span>`:'';
      const badge=statusObj?`<span class="pill ${statusObj.cls}">${statusObj.label}</span>`:'';
      tds[dateCol]=`<td>${urgentFlag} ${badge} ${dateText}</td>`;

      const itemKey = S(valAt(r, idx.draw) || valAt(r, idx.item) || valAt(r, idx.note));
      const latest = latestMap[itemKey];
      tds.push(`<td>${latest?S(latest.event):'-'}</td>`);
      tds.push(`<td>${latest?S(latest.location):'-'}</td>`);
      tbodyEl.insertAdjacentHTML('beforeend', `<tr>${tds.join('')}</tr>`);
    });
  }

  function renderProcessBoard(stats){
    const box=document.getElementById('procPills'),
          hint=document.getElementById('procHint');
    box.innerHTML='';
    if(!stats||!stats.event){ hint.textContent='ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'; return; }
    ['RECEIVE','WIP','QC','PACK','SHIP'].forEach(k=>{
      const v=stats.event[k]||0; box.insertAdjacentHTML('beforeend', `<div class="pill">${k} ${v}</div>`);
    });
    const locPairs=Object.entries(stats.location||{}).sort((a,b)=>b[1]-a[1]).slice(0,6);
    locPairs.forEach(([loc,c])=> box.insertAdjacentHTML('beforeend', `<div class="pill">LOC ${loc}: ${c}</div>`));
    hint.textContent = `æœ€æ–°ï¼šã‚¢ã‚¤ãƒ†ãƒ æ•° ${stats.total ?? 0}`;
  }

  // ===== Main loader =====
  let aborter=null, isLoading=false;
  let cached={header:[], rows:[], idx:null, cmp:null};
  let _scanData={map:{}, stats:{}};

  async function load(){
    try{
      if(isLoading){ if(aborter) aborter.abort(); }
      isLoading=true; const btn=document.getElementById('btnRefresh'); const old=btn.textContent;
      btn.textContent='Loading...'; btn.disabled=true;

      aborter=new AbortController();
      const res=await fetch(CSV_URL + "&_ts=" + Date.now(), {signal:aborter.signal, cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text=await res.text(); const data=parseCSV(text); if(!data.length) throw new Error('CSV empty');

      const header=data[0], rowsRaw=data.slice(1); const idx=indexByName(header); const cmp=makeComparator(idx);
      const rows=[...rowsRaw].sort(cmp); cached={header, rows, idx, cmp};

      _scanData = await fetchScanMap();

      const urgentCount = rows.reduce((n,r)=> n + (idx.status_flag!=null && isUrgent(valAt(r, idx.status_flag)) ? 1 : 0), 0);
      document.getElementById('urgent-banner').textContent =
        urgentCount>0 ? `âš  è‡³æ€¥æ¡ˆä»¶ãŒ ${urgentCount} ä»¶ã‚ã‚Šã¾ã™ï¼æ—©æ€¥ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚` : 'ç¾åœ¨ã€è‡³æ€¥æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';

      renderProcessBoard(_scanData.stats);
      renderTodaySection();
      applyFilter(null);

      const cols=[];
      if(idx.qty!=null) cols.push('æ•°é‡:'+header[idx.qty]);
      if(idx.cust!=null) cols.push('é¡§å®¢:'+header[idx.cust]);
      if(idx.date!=null) cols.push('å‡ºè·æ—¥:'+header[idx.date]);
      document.getElementById('shipHint').textContent =
        `ãƒ‡ãƒ¼ã‚¿å…ƒ: ${TAB_NAME}ï¼ˆ${rows.length} è¡Œï¼‰ï½œ${cols.join(' ï½œ ')} ï½œ Urgentåˆ—: ${idx.status_flag!=null ? header[idx.status_flag] : 'â€”'}`;
      document.getElementById('filterDate').value = toInputDate(new Date());

      btn.textContent=old; btn.disabled=false; isLoading=false;
    }catch(e){
      console.error(e);
      const btn=document.getElementById('btnRefresh'); btn.textContent='Refresh now'; btn.disabled=false; isLoading=false;
      document.getElementById('shipHint').textContent='èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆå/å…¬é–‹è¨­å®š/åˆ—åã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
    }
  }

  function renderTodaySection(){
    const { header, rows, idx, cmp } = cached;
    if(idx.date==null){ document.getElementById('todaySection').style.display='none'; return; }
    const today = new Date();
    const todayRows = rows.filter(r=>{ const d=parseJPDate(valAt(r, idx.date)); return d && sameYMD(d,today); }).sort(cmp);
    const visible = todayRows.length>0;
    document.getElementById('todaySection').style.display = visible ? '' : 'none';
    if(!visible) return;
    document.getElementById('todayCount').textContent = todayRows.length;
    renderTable(header, idx, todayRows, document.getElementById('todayBody'), document.getElementById('todayHead'), _scanData.map);
  }

  // ===== Filter & export =====
  function applyFilter(dateStr){
    const { header, rows, idx, cmp } = cached;
    let view = rows;
    if(idx.date!=null && dateStr){
      const target=new Date(dateStr+"T00:00:00");
      view = rows.filter(r=>{ const d=parseJPDate(valAt(r, idx.date)); return d && sameYMD(d,target); }).sort(cmp);
    }
    renderTable(header, idx, view, document.getElementById('shipBody'), document.getElementById('shipHead'), _scanData.map);
  }
  function exportExcel(){
    const wb=XLSX.utils.table_to_book(document.getElementById("shipTable"),{sheet:"å‡ºè·çŠ¶æ³"});
    XLSX.writeFile(wb,"å‡ºè·çŠ¶æ³.xlsx");
  }

  // ===== Auto refresh =====
  let timer=null, intervalMs=60000;
  function startAutoRefresh(ms){
    intervalMs=ms; clearInterval(timer);
    timer=setInterval(()=>{ if(document.visibilityState==='visible') load(); }, intervalMs);
    document.getElementById('intervalInfo').textContent = `${Math.round(intervalMs/1000)}s`;
    const liveBtn=document.getElementById('btnLive');
    if(intervalMs<=5000){ liveBtn.classList.add('primary'); liveBtn.textContent='Live: On'; }
    else{ liveBtn.classList.remove('primary'); liveBtn.textContent='Live: Off'; }
  }

  // ===== Scanner modal =====
  let codeReader=null;
  const scanModal=document.createElement('div');
  scanModal.className='modal';
  scanModal.innerHTML=`<div class="box">
    <div class="hstack" style="justify-content:space-between"><strong>ã‚¹ã‚­ãƒ£ãƒ³</strong><button class="btn" id="scanClose">é–‰ã˜ã‚‹</button></div>
    <div class="hstack" style="margin:8px 0; flex-wrap:wrap">
      <select id="scanEvent" class="btn">
        <option value="RECEIVE">RECEIVEï¼ˆå—å…¥ï¼‰</option>
        <option value="WIP">WIPï¼ˆå·¥ç¨‹ä¸­ï¼‰</option>
        <option value="QC">QCï¼ˆæ¤œæŸ»ï¼‰</option>
        <option value="PACK">PACKï¼ˆæ¢±åŒ…ï¼‰</option>
        <option value="SHIP">SHIPï¼ˆå‡ºè·ï¼‰</option>
      </select>
      <input id="scanLocation" class="btn" placeholder="Location ä¾‹: å€‰åº«A / çµ„ç«‹1 / å‡ºè·ãƒ¤ãƒ¼ãƒ‰">
      <input id="scanNote" class="btn" placeholder="Note (ä»»æ„)">
    </div>
    <video id="scanVideo" style="width:100%; border:1px solid var(--line); border-radius:12px"></video>
    <div id="scanHint" class="small" style="margin-top:6px"></div>
  </div>`;
  document.body.appendChild(scanModal);

  async function openScanner(){
    scanModal.style.display='flex';
    if(!codeReader){ codeReader = new ZXingBrowser.BrowserMultiFormatReader(); }
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const deviceId = devices?.[0]?.deviceId;
    document.getElementById('scanHint').textContent = devices.length ? 'ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­â€¦' : 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
    if(!deviceId) return;
    const scanVideo=document.getElementById('scanVideo');
    await codeReader.decodeFromVideoDevice(deviceId, scanVideo, async (result, err, controls)=>{
      if(result){
        controls.stop();
        const itemId=result.getText();
        document.getElementById('scanHint').textContent=`èª­ã¿å–ã‚Š: ${itemId} â†’ é€ä¿¡ä¸­â€¦`;
        try{
          const payload={ token:LOG_TOKEN, action:'scan', item_id:itemId,
            event:document.getElementById('scanEvent').value,
            location:document.getElementById('scanLocation').value||'',
            user:CURRENT_USER, note:document.getElementById('scanNote').value||'' };
          const res=await fetch(LOG_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const j=await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
          if(j.ok){ document.getElementById('scanHint').textContent='è¨˜éŒ²ã—ã¾ã—ãŸ âœ…'; await load(); setTimeout(closeScanner,600); }
          else{ document.getElementById('scanHint').textContent='é€ä¿¡å¤±æ•—: '+(j.error||res.status); }
        }catch(e){ document.getElementById('scanHint').textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼: '+e.message; }
      }
    });
  }
  function closeScanner(){ scanModal.style.display='none'; try{ codeReader?.reset(); }catch(e){} }

  // ===== Manual input modal =====
  const manualModal=document.createElement('div');
  manualModal.className='modal';
  manualModal.innerHTML=`<div class="box">
    <div class="hstack" style="justify-content:space-between"><strong>å…¥åŠ›ï¼ˆæ‰‹å‹•ï¼‰</strong><button class="btn" id="manualClose">é–‰ã˜ã‚‹</button></div>
    <div class="hstack" style="flex-direction:column;align-items:stretch;margin:8px 0">
      <input id="mItemId" placeholder="Item IDï¼ˆå›³ç•ª/æ³¨ç•ª ç­‰ï¼‰" required>
      <select id="mEvent" required>
        <option value="">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ</option>
        <option value="RECEIVE">RECEIVEï¼ˆå—å…¥ï¼‰</option>
        <option value="WIP">WIPï¼ˆå·¥ç¨‹ä¸­ï¼‰</option>
        <option value="QC">QCï¼ˆæ¤œæŸ»ï¼‰</option>
        <option value="PACK">PACKï¼ˆæ¢±åŒ…ï¼‰</option>
        <option value="SHIP">SHIPï¼ˆå‡ºè·ï¼‰</option>
      </select>
      <input id="mLocation" placeholder="Location ä¾‹: å€‰åº«A / çµ„ç«‹1">
      <input id="mNote" placeholder="Note (ä»»æ„)">
      <button class="btn primary" id="mSubmit">Submit</button>
    </div>
    <div id="mHint" class="small"></div>
  </div>`;
  document.body.appendChild(manualModal);

  async function submitManual(){
    const item_id=S(document.getElementById('mItemId').value);
    const eventV=S(document.getElementById('mEvent').value);
    const location=S(document.getElementById('mLocation').value);
    const note=S(document.getElementById('mNote').value);
    if(!item_id) return document.getElementById('mHint').textContent='Item ID ã¯å¿…é ˆã§ã™ã€‚';
    if(!eventV)  return document.getElementById('mHint').textContent='ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
    document.getElementById('mHint').textContent='é€ä¿¡ä¸­â€¦';
    try{
      const payload={ token:LOG_TOKEN, action:'scan', item_id, event:eventV, location, user:CURRENT_USER, note };
      const res=await fetch(LOG_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await res.json().catch(()=>({ok:false,error:'Invalid JSON'}));
      if(j.ok){
        document.getElementById('mHint').textContent='è¨˜éŒ²ã—ã¾ã—ãŸ âœ…';
        await load(); setTimeout(()=>{ manualModal.style.display='none'; },600);
        document.getElementById('mItemId').value=''; document.getElementById('mEvent').value='';
        document.getElementById('mLocation').value=''; document.getElementById('mNote').value='';
      } else document.getElementById('mHint').textContent='é€ä¿¡å¤±æ•—: '+(j.error||res.status);
    }catch(e){ document.getElementById('mHint').textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼: '+e.message; }
  }

  // ===== Events =====
  // header buttons
  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnLive').addEventListener('click', ()=>{ startAutoRefresh(intervalMs<=5000?60000:5000); load(); });
  document.getElementById('btnScan').addEventListener('click', openScanner);
  document.getElementById('btnExcel').addEventListener('click', exportExcel);
  document.getElementById('btnToday').addEventListener('click', ()=> applyFilter(toInputDate(new Date())));
  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('filterDate').value=""; applyFilter(null); });
  document.getElementById('filterDate').addEventListener('change', e=> applyFilter(e.target.value||null));
  document.getElementById('btnManual').addEventListener('click', ()=>{ manualModal.style.display='flex'; });

  // drawer buttons
  const drawer=document.getElementById('drawer');
  const openDrawer=()=> drawer.classList.add('open');
  const closeDrawer=()=> drawer.classList.remove('open');
  document.getElementById('menuBtn').addEventListener('click', openDrawer);
  document.getElementById('drawerClose').addEventListener('click', closeDrawer);
  document.getElementById('drawerCloseBtn').addEventListener('click', closeDrawer);
  document.getElementById('btnRefresh2').addEventListener('click', ()=>{ closeDrawer(); load(); });
  document.getElementById('btnLive2').addEventListener('click', ()=>{ closeDrawer(); startAutoRefresh(intervalMs<=5000?60000:5000); load(); });
  document.getElementById('btnScan2').addEventListener('click', ()=>{ closeDrawer(); openScanner(); });
  document.getElementById('btnManual2').addEventListener('click', ()=>{ closeDrawer(); manualModal.style.display='flex'; });

  // bottom nav quick actions
  document.getElementById('bnScan').addEventListener('click', openScanner);
  document.getElementById('bnMore').addEventListener('click', openDrawer);

  // modal events
  scanModal.addEventListener('click', e=>{ if(e.target===scanModal) closeScanner(); });
  scanModal.querySelector('#scanClose').addEventListener('click', closeScanner);
  manualModal.addEventListener('click', e=>{ if(e.target===manualModal) manualModal.style.display='none'; });
  manualModal.querySelector('#manualClose').addEventListener('click', ()=> manualModal.style.display='none');
  manualModal.querySelector('#mSubmit').addEventListener('click', submitManual);

  // boot
  window.addEventListener('DOMContentLoaded', ()=>{ load(); startAutoRefresh(60000); });
  </script>
</body>
</html>
