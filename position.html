<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ポジション | 品質管理生産技術</title>
<link rel="icon" href="tsh.png">
<link rel="stylesheet" href="./assets/ui.css">
</head>
<body>
<header>
  <div class="wrap">
    <div class="hstack">
      <a href="./index.html" class="btn">←</a>
      <img src="tsh.png" alt="TSH" style="height:32px">
      <strong>ポジション</strong>
    </div>
    <div class="hstack">
      <button id="btnRefresh" class="btn">Refresh</button>
    </div>
  </div>
</header>

<main class="wrap" style="margin:28px auto">
  <section class="card">
    <div class="hstack" style="justify-content:space-between;flex-wrap:wrap">
      <h2>現在位置（最新スキャン集計）</h2>
      <div class="hstack">
        <input id="q" placeholder="位置で絞り込み（例: 組立 / 倉庫）">
        <span id="total" class="badge small">0</span>
      </div>
    </div>
    <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px"></div>
    <div class="small" id="hint"></div>
  </section>
</main>

<div class="footer">Design by Wahyu</div>

<script src="./assets/config.js"></script>
<script>
const LOG_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmw6oMhjQRmXjSL9R9PhBZGa0aJ5WrxHKYzcOpACGOo1GEV0NimYgpTAsnUiNg7nT4tEQ-euqDSSVt/pub?gid=2085218630&single=true&output=csv";
const S=s=>String(s??'').trim();
function parseCSV(t){const r=[],re=/\s*("(?:[^"]|"")*"|[^,]*)\s*(,|\n|$)/g;let m,row=[];
t=t.replace(/\r\n?/g,"\n");for(let i=0;i<t.length;){re.lastIndex=i;m=re.exec(t);if(!m)break;let c=m[1];if(c.startsWith('"'))c=c.slice(1,-1).replace(/""/g,'"');row.push(c);i=re.lastIndex;if(m[2]==="\n"||m[2]===""){r.push(row);row=[]}}return r.filter(a=>a.length&&a.some(c=>S(c)!==""));}

async function load(){
  document.getElementById('grid').innerHTML='';
  const res=await fetch(LOG_CSV+"&_ts="+Date.now(),{cache:'no-store'}); if(!res.ok) return;
  const rows=parseCSV(await res.text()); if(rows.length<2) return;
  const h=rows[0].map(S); const iLoc=h.indexOf('location'), iId=h.indexOf('item_id'), iTS=h.indexOf('ts');
  const latest={};
  for(let k=1;k<rows.length;k++){
    const id=S(rows[k][iId]); const ts=new Date(S(rows[k][iTS])||0).getTime(); if(!id||!ts) continue;
    if(!latest[id]||ts>latest[id].ts){ latest[id]={ts,loc:S(rows[k][iLoc])||'-'}; }
  }
  const counts={}; Object.values(latest).forEach(v=>{ const key=v.loc||'-'; counts[key]=(counts[key]||0)+1; });
  render(counts);
}
function render(map){
  const q=S(document.getElementById('q').value).toLowerCase();
  const entries=Object.entries(map).filter(([k])=>k.toLowerCase().includes(q)).sort((a,b)=>b[1]-a[1]);
  const grid=document.getElementById('grid'); grid.innerHTML='';
  entries.forEach(([loc,c])=>{
    grid.insertAdjacentHTML('beforeend', `<div class="card" style="padding:14px">
      <div class="hstack" style="justify-content:space-between">
        <strong>${loc||'-'}</strong>
        <span class="badge">${c}</span>
      </div>
    </div>`);
  });
  document.getElementById('total').textContent = 'LOC数: '+entries.length;
  document.getElementById('hint').textContent = '最新スキャンに基づく現在位置の概数です。';
}
document.getElementById('btnRefresh').addEventListener('click', load);
document.getElementById('q').addEventListener('input', load);
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
